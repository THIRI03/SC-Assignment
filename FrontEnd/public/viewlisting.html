<script>
	$(document).ready(function () {
	  // Retrieve and parse user data from local storage
	  var userData = localStorage.getItem('userData');
	  var username, userid;
  
	  if (userData) {
		try {
		  var userDataJson = JSON.parse(userData);
		  username = userDataJson[0]?.username;
		  userid = userDataJson[0]?.id;
		} catch (error) {
		  console.error("Error parsing userData:", error);
		}
	  }
  
	  if (username) {
		$('#profile').html(username);
	  }
  
	  // Get listing ID from URL
	  var urlParams = new URLSearchParams(window.location.search);
	  var listingid = urlParams.get("listingid");
  
	  if (!listingid) {
		alert("Invalid or missing listing ID");
		return;
	  }
  
	  var token = localStorage.getItem('token');
  
	  // Fetch listing details
	  $.ajax({
		url: "http://localhost:8081/listing/" + listingid + "/",
		type: "GET",
		contentType: "application/json",
		dataType: "json",
		beforeSend: function (xhr) {
		  xhr.setRequestHeader("listingId", listingid);
		},
		success: function (data) {
		  if (data.success) {
			var postsHtml = "";
			var listing = data.result[0];
  
			if (listing.fk_poster_id == userid) {
			  postsHtml += `
				<div class="container-fluid">
				  <div class="wrapper row">
					<div class="preview col-md-6">
					  <div class="preview-pic tab-content">
						<div class="tab-pane active" id="pic-1">
						  <img class="card-img-top" width="507px" height="450.65px"
							src="http://localhost:8081/${listing.name}" alt="Listing Image">
						</div>
					  </div>
					</div>
					<div class="details col-md-6">
					  <h3 class="product-title">${listing.title}</h3>
					  <h4>Category: ${listing.category}</h4>
					  <p class="product-description">Description: ${listing.description}</p>
					  <p>Posted by: ${listing.username}</p>
					  <h4 class="price">Price: $<span>${listing.price}</span></h4>
					  <div class="action">
						<button class="btn btn-primary" id="edit" type="button">Edit</button>
					  </div>
					</div>
				  </div>
				</div>`;
			} else {
			  postsHtml += `
				<div class="container-fluid">
				  <div class="wrapper row">
					<div class="preview col-md-6">
					  <div class="preview-pic tab-content">
						<div class="tab-pane active" id="pic-1">
						  <img class="card-img-top" width="507px" height="450.65px"
							src="http://localhost:8081/${listing.name}" alt="Listing Image">
						</div>
					  </div>
					</div>
					<div class="details col-md-6">
					  <h3 class="product-title">${listing.title}</h3>
					  <h4>Category: ${listing.category}</h4>
					  <p class="product-description">Description: ${listing.description}</p>
					  <p>Posted by: ${listing.username}</p>
					  <h4 class="price">Price: $<span>${listing.price}</span></h4>
					  <div class="action">
						<form class="form-inline">
						  <div class="input-group input-group-sm">
							<input type="text" size="15" class="form-control" id="offer" placeholder="Input your offer">
						  </div>
						  <button class="btn btn-primary" id="button" type="button">Offer</button>
						  <button class="btn btn-danger" id="like" type="button">
							<span id="amount" class="fa fa-heart">2</span>
						  </button>
						</form>
					  </div>
					</div>
				  </div>
				</div>`;
			}
  
			$('#listing').html(postsHtml);
  
			// Fetch likes
			$.ajax({
			  url: "http://localhost:8081/likes/" + listingid + "/",
			  type: "GET",
			  contentType: "application/json",
			  beforeSend: function (xhr) {
				xhr.setRequestHeader("listingId", listingid);
			  },
			  success: function (data) {
				if (data.success) {
				  $('#amount').html(data.amount);
				} else {
				  alert("Unsuccessful in getting likes");
				}
			  },
			  error: function () {
				alert("Error fetching likes");
			  }
			});
  
			// Like/Unlike listing
			$('#like').click(function () {
			  $.ajax({
				headers: {
				  "authorization": "Bearer " + token,
				  "listingId": listingid
				},
				url: "http://localhost:8081/likeorunlike/" + listingid + "/",
				type: "GET",
				contentType: "application/json",
				success: function (data) {
				  if (data.success) {
					location.reload();
				  } else {
					alert("Could not like/unlike this post");
				  }
				},
				error: function () {
				  alert("Error during like/unlike operation");
				}
			  });
			});
  
			// Offer on listing
			$('#button').click(function () {
			  var offer = $('#offer').val();
			  var data = JSON.stringify({ offer: offer, fk_listing_id: listingid });
  
			  $.ajax({
				headers: {
				  "authorization": "Bearer " + token,
				  "listingId": listingid
				},
				url: "http://localhost:8081/offer/",
				type: "POST",
				data: data,
				contentType: "application/json",
				success: function (data) {
				  if (data.success) {
					alert("Offer has been made");
					location.reload();
				  } else {
					alert("Unsuccessful in making an offer");
				  }
				},
				error: function () {
				  alert("Error while making an offer");
				}
			  });
			});
  
			// Edit listing
			$('#edit').click(function () {
			  window.location.assign("http://localhost:3001/editlisting.html?listingid=" + listingid);
			});
		  } else {
			alert("Error in retrieving listing details");
		  }
		},
		error: function () {
		  alert("Error fetching listing data");
		}
	  });
  
	  // Logout function
	  $('#logout').click(function () {
		$.ajax({
		  url: "http://localhost:8081/user/logout",
		  type: "POST",
		  contentType: "application/json",
		  success: function () {
			localStorage.clear();
			window.location.assign("http://localhost:3001/loginPage.html");
		  },
		  error: function () {
			console.error("Error during logout");
		  }
		});
	  });
  
	  // Search functionality
	  $('#searchbutton').click(function () {
		var search = $('#search').val();
		window.location.assign("http://localhost:3001/searchlistings.html?search=" + search);
	  });
	});
  </script>
  